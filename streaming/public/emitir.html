<!doctype html>

<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Let's Every Busking!</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="http://192.168.253.138/css/modern-business.css" rel="stylesheet">
    <link href="http://192.168.253.138/css/public.css" rel="stylesheet">

    <link href="http://192.168.253.138/public/side_bar.css" rel="stylesheet">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"
          id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <style>
        .video-div video {
            width: 100%;
            height: 440px;
        }

        #videos-container {
            text-align: center;

        }
    </style>

</head>
<body>

<!--사이드바-->
<div id="wrapper" class="animate">
    <nav class="navbar header-top fixed-top navbar-expand-lg navbar-dark bg-dark">
        <span class="navbar-toggler-icon leftmenutrigger"></span>
        <a class="navbar-brand" href="http://192.168.253.138/main.php"
           style="font-family: 'Monoton', cursive; margin-left: 10px; font-size: 20px;">Every
            Busking</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
                aria-controls="navbarText"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav animate side-nav">
                <li class="nav-item">
                    <a class="nav-link menu_buskingteam" href="http://192.168.253.138//buskingteam/buskingteam.php"
                       title="Dashboard"><i
                            class="fas fa-users side_bar_img"></i>Busking Team<i
                            class="fas fa-cube shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_busking_zone" href="http://192.168.253.138//busking_zone/busking_zone.php"
                       title="Cart"><i
                            class="fas fa-map-marker-alt side_bar_img"></i>Busking Zone<i
                            class="fas fa-cart-plus shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_streaming" href="http://192.168.253.138//streaming/waiting_room.php"
                       title="Comment"><i
                            class="fas fa-video side_bar_img"></i>Streaming<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_community" href="http://192.168.253.138//community/community.php"
                       title="Comment"><i
                            class="fas fa-star side_bar_img"></i>Community<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_concert" href="http://192.168.253.138//concert/concert.php" title="Comment"><i
                            class="fas fa-compact-disc side_bar_img"></i>Cloud Concert<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
            </ul>
            <ul class="navbar-nav ml-md-auto d-md-flex">
                <li class="nav-item">
                    <a class="nav-link" id="user_id_id"></a>

                </li>
                <li class="nav-item">
                    <a class="nav-link main_nav_sign" href="/Sign/sign_out.php"><i class="fas fa-key"></i> Sign Out</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link menu_profile" href="http://192.168.253.138/my_page/my_page_modify.php"><i
                            class="fas fa-user"></i>My Page</a>
                </li>

            </ul>
        </div>
    </nav>
</div>

<div class="container my_font_main" style="min-height: 850px; padding-top: 10px;">

    <h1 class="mt-4 mb-3 my_font_index" style="color: #FBAA48">Streaming</h1>

    <h6 class="my_font_main">※ 깨끗한 인터넷 문화를 만들어갑시다. :)</h6>

    <div class="row" style="height: 440px; margin-top: 70px">
        <div class="col-lg-8">
            <div id="videos-container" autoplay controls>

            </div>
            <!--<div id="logger"></div>-->
        </div>

        <div class="col-lg-4" style="height: 100%;">
            <div id="messages" style="height: 300px; border: transparent 1px solid; overflow: auto">

            </div>

            <div id='whoIsInBox' style="min-height: 80px; height: 80px; border: transparent 1px solid;overflow: auto">

                <h4>참여자</h4>

                <div id='whoIsIn' style="border: transparent 1px solid;overflow: auto">
                </div>

            </div>

            <div style="margin-top: 10px;">
                <form id='typeForm' style="border: transparent 1px solid;">
                    <input class="input-group-text" id="m" autocomplete="off"
                           style="width: 270px; display: inline; background-color: white; text-align: left"/>
                    <button class="btn hover_class" id="support_hover" style="width: 70px;">보내기</button>
                </form>
            </div>
        </div>

    </div>

    <div style="margin-top: 100px">
        <form method="post" action="http://192.168.253.138/streaming/waiting_room_delete_p.php"
              style="width: 540px; display: inline">
            <button type="submit" class="btn my_font_main hover_class support_hover22"
                    style="font-size: 18px; width: 180px; margin-left: 470px" id="support_hover22">방송 종료하기
            </button>
            <input id="now_room_idx" type="hidden" name="now_room_idx" value="">
        </form>

        <!--<button class="btn my_font_main hover_class" style="font-size: 18px; width: 180px; display: inline"-->
        <!--id="support_hover3" onclick="">방송 녹화하기-->
        <!--</button>-->

        <video id="recorded" style="display: none"></video>

    </div>

    <div>

        <button class=" btn re_hover_class" id="record" disabled>녹화 시작하기</button>

        <button class="btn re_hover_class"  id="play" disabled style="display: none">Play</button>

        <button class="btn re_hover_class"  id="download" disabled>영상 저장하기</button>

    </div>

</div>

<!-- Footer -->
<div data-role="footer" data-position="fixed" class="m_footer">
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white my_font_logo">Every Busking</p>
        </div>
        <!-- /.container -->
    </footer>
</div>

<script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>
<script src="http://192.168.253.138/public/side_bar.js"></script>

<script>

    var rooming;

    //when the document is ready.
    // $(function () {
    //about DOM
    $('#m').focus();

    var socket = io();

    //socket io
    var typingNotice = ' 님께서 입력 중';
    var nickName = '';
    var user_name = '';
    var whoIsTyping = [];
    var newbie;

    $('#typeForm').submit(function () {
        //submit only if it's not empty
        if ($('#m').val() != "") {
            socket.emit('say', $('#m').val());
            //say event means someone transmitted chat
            $('#m').val('');
            socket.emit('quitTyping')
        }
        return false;
    });

    $('.support_hover22').click(function () {
        socket.emit('room_boom', "강퇴");
        return true;
    });

    socket.on('room_boom', function () {
        alert("방송이 종료 되었습니다.");
        document.location.href = "http://192.168.253.138/streaming/waiting_room.php";
    });

    socket.on('room_boom_re', function () {
        alert("방송이 잠시 중단 되었습니다.");
        document.location.href = "http://192.168.253.138/streaming/waiting_room.php";
    });

    socket.on('room_room', function () {
        alert("운영자의 의해 방송이 종료 되었습니다.");
        document.location.href = "http://192.168.253.138/streaming/waiting_room.php";
    });

    $('#nickNameForm').submit(function () {
        nickName = $('#nickName').val();
        $('#nickName').attr('placeholder', 'NickName : ' + nickName);
        socket.emit('setNickName', nickName);
        $('#nickName').val("");
        $('#m').focus();
        return false;
    })

    socket.on('selfData', function (obj) {
        nickName = obj.nickName;
        user_name = obj.user_name;
        rooming = obj.room_idx;
        $('#nickName').attr('placeholder', 'NickName : ' + nickName);
        //set #nickNameForm placeholder
        $('#user_id_id').text(user_name + " 님");
        $("#now_room_idx").val(rooming);
    });

    //채팅방 입장 문구
    socket.on('login', function (nickNameArr) {
        newbie = nickNameArr[nickNameArr.length - 1];
        $('#messages').append($('<h6>').text(newbie + "님께서 입장하셨습니다."));
        editUsers(nickNameArr);
    });

    socket.on('logout', function (received) {
        var nickNameArr = received.nickNameArr;
        var disconnected = received.disconnected;
        $('#messages').append($('<li>').text(`${disconnected} 님께서 나가셨습니다.`));
        editUsers(nickNameArr);
    });

    socket.on('mySaying', function (msg) {
        $('#messages').append($('<h6>').text(msg));
        $('#messages').scrollTop($('#messages')[0].scrollHeight);
    });

    socket.on('chat message', function (msg) {
        $('#messages').append($('<h6>').text(msg));
        $('#messages').scrollTop($('#messages')[0].scrollHeight);
    });

    function editUsers(nickNameArr) {

        $('#whoIsInBox div').children().each((index, item) => {
            $(item).remove();
        });
        for (person in nickNameArr) {
            $('#whoIsInBox div').append($('<h6>').text(nickNameArr[person]));
        }
    };

    socket.on('typing', function (nickNameArr) {
        var tempMsg = null;
        whoIsTyping = nickNameArr;
        for (person in nickNameArr) {
            tempMsg += nickNameArr[person] + ', '
        }
        tempMsg = tempMsg.substring(0, tempMsg.length - 1);
        $('#m').attr('placeholder', tempMsg + typingNotice)
    });

    socket.on('endTyping', function () {
        console.log('endTyping');
        whoIsTyping = [];
        $('#m').attr('placeholder', "");
    });

    socket.on('stream', function (image) {
        var img = document.getElementById("play");
        img.src = image;
    });

    $('#m').keyup(function (event) {

        if ($('#m').val() != "" && !whoIsTyping.includes(nickName)) {
            socket.emit('typing');
            console.log('emit typing');
        } else if ($('#m').val() == "" && whoIsTyping.includes(nickName)) {

            socket.emit('quitTyping');
            console.log('emit quitTyping');

        }
    });

    // });

    //뒤로가기 충돌 방지
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        document.location.href = "http://192.168.253.138/streaming/waiting_room.php";
    };

</script>

<!--새로고침 방지-->
<script language="javascript" type="text/javascript" src="../common/scripts/jquery-latest.js"></script>
<script type="text/javascript">
    $(document).keydown(function (e) {
        key = (e) ? e.keyCode : event.keyCode;
        // alert(key);
        var t = document.activeElement;
        if (key == 116) {
            if (e) {
                e.preventDefault();
            } else {
                event.keyCode = 0;
                event.returnValue = false;
            }
            alert("원활한 방송을 위해 새로고침이 방지 되어 있습니다.");
        }
    });

</script>

<!--<script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.min.js"></script>-->
<script src="http://192.168.253.138/streaming/demo/asdasd.js"></script>
<script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>

<script>

    var connection = new RTCMultiConnection();

    // this line is VERY_important
    connection.socketURL = "http://192.168.253.138:3001/";

    connection.session = {
        audio: true,
        video: true,
        oneway: true
    };

    connection.sdpConstraints.mandatory = {
        OfferToReceiveAudio: true,
        OfferToReceiveVideo: true
    };

    var videosContainer = document.getElementById('videos-container');
    connection.onstream = function (event) {
        delete event.mediaElement.id; // make sure that below DIV has unique ID in the DOM

        var div = document.createElement('div');
        div.id = event.streamid;
        div.className = 'video-div';
        div.appendChild(event.mediaElement); // appending VIDOE to DIV

        div.style.backgroundColor = event.extra.divBGColor;

        videosContainer.appendChild(div);
    };

    connection.onstreamended = function (event) {
        var div = document.getElementById(event.streamid);
        if (div && div.parentNode) {
            div.parentNode.removeChild(div); // remove it from the DOM
        }
    };

    $(function () {
        // consider the URL as UNIQUE-ROOM-ID
        connection.channel = rooming;

        connection.openOrJoin(connection.channel);

        console.log("룸 번호 : " + rooming);
        console.log(connetion.channel);
    });

</script>

<script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

<script>

    $(window).load(function () {

        var mediaSource = new MediaSource();

        mediaSource.addEventListener('sourceopen', handleSourceOpen, false);

        var mediaRecorder;

        var recordedBlobs;

        var sourceBuffer;

        var gumVideo = document.querySelector('video#gum');

        var recordedVideo = document.querySelector('video#recorded');

        var recordButton = document.querySelector('button#record');

        var playButton = document.querySelector('button#play');

        var downloadButton = document.querySelector('button#download');

        recordButton.onclick = toggleRecording;

        playButton.onclick = play;

        downloadButton.onclick = download;

        var isSecureOrigin = location.protocol === 'https:' ||

            location.hostname === '192.168.253.138';

        if (!isSecureOrigin) {

            alert('getUserMedia() must be run from a secure origin: HTTPS or localhost.' +

                '\n\nChanging protocol to HTTPS');

            location.protocol = 'HTTPS';

        }

        var constraints = {
            audio: true,
            video: true
        };

        function handleSuccess(stream) {
            recordButton.disabled = false;

            console.log('getUserMedia() got stream: ', stream);

            window.stream = stream;

            // if (window.URL) {
            //
            //     // gumVideo.src = window.URL.createObjectURL(stream);
            //     gumVideo.srcObject = stream;
            //
            // } else {
            //
            //     gumVideo.src = stream;
            //
            // }

        }

        function handleError(error) {

            console.log('navigator.getUserMedia error: ', error);

        }

        navigator.mediaDevices.getUserMedia(constraints).then(handleSuccess).catch(handleError);

        function handleSourceOpen(event) {

            console.log('MediaSource opened');

            sourceBuffer = mediaSource.addSourceBuffer('video/webm; codecs="vp8"');

            console.log('Source buffer: ', sourceBuffer);

        }

        recordedVideo.addEventListener('error', function (ev) {

            console.error('MediaRecording.recordedMedia.error()');

            alert('Your browser can not play\n\n' + recordedVideo.src

                + '\n\n media clip. event: ' + JSON.stringify(ev));

        }, true);

        function handleDataAvailable(event) {

            if (event.data && event.data.size > 0) {

                recordedBlobs.push(event.data);

            }

        }

        function handleStop(event) {

            console.log('Recorder stopped: ', event);

        }

        function toggleRecording() {

            if (recordButton.textContent === '녹화 시작하기') {

                startRecording();

            } else {

                stopRecording();

                recordButton.textContent = '녹화 시작하기';

                playButton.disabled = false;

                downloadButton.disabled = false;

            }

        }

        function startRecording() {

            recordedBlobs = [];

            var options = {mimeType: 'video/mp4;codecs=vp9'};

            if (!MediaRecorder.isTypeSupported(options.mimeType)) {

                console.log(options.mimeType + ' is not Supported');

                options = {mimeType: 'video/mp4;codecs=vp8'};

                if (!MediaRecorder.isTypeSupported(options.mimeType)) {

                    console.log(options.mimeType + ' is not Supported');

                    options = {mimeType: 'video/mp4'};

                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {

                        console.log(options.mimeType + ' is not Supported');

                        options = {mimeType: ''};

                    }

                }

            }

            try {

                mediaRecorder = new MediaRecorder(window.stream, options);

            } catch (e) {

                console.error('Exception while creating MediaRecorder: ' + e);

                alert('Exception while creating MediaRecorder: '

                    + e + '. mimeType: ' + options.mimeType);

                return;

            }

            console.log('Created MediaRecorder', mediaRecorder, 'with options', options);

            recordButton.textContent = '녹화 중지하기';

            playButton.disabled = true;

            downloadButton.disabled = true;

            mediaRecorder.onstop = handleStop;

            mediaRecorder.ondataavailable = handleDataAvailable;

            mediaRecorder.start(10); // collect 10ms of data

            console.log('MediaRecorder started', mediaRecorder);

        }

        function stopRecording() {

            mediaRecorder.stop();

            console.log('Recorded Blobs: ', recordedBlobs);

            recordedVideo.controls = true;

        }

        function download() {

            var blob = new Blob(recordedBlobs, {type: 'video/mp4'});

            console.log(blob);

            var url = window.URL.createObjectURL(blob);

            var a = document.createElement('a');

            a.style.display = 'none';

            a.href = url;

            var currentDate = new Date();

            var msg = currentDate.getFullYear() + "년";
            msg += (currentDate.getMonth() + 1) + "월";
            msg += currentDate.getDate() + "일";

            msg += currentDate.getHours() + "시";
            msg += currentDate.getMinutes() + "분 방송";

            a.download = msg + ".mp4";

            document.body.appendChild(a);

            a.click();

            setTimeout(function () {

                document.body.removeChild(a);

                window.URL.revokeObjectURL(url);

            }, 100);

        }
    })

</script>

</body>
</html>