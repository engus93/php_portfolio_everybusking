<!doctype html>

<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Let's Every Busking!</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="http://192.168.253.138/css/modern-business.css" rel="stylesheet">
    <link href="http://192.168.253.138/css/public.css" rel="stylesheet">

    <link href="http://192.168.253.138/public/side_bar.css" rel="stylesheet">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"
          id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>

        //when the document is ready.
        $(function () {
            //about DOM
            $('#m').focus();

            //socket io
            var socket = io();
            var typingNotice = ' 님께서 입력 중';
            var fontColor = 'black';
            var nickName = '';
            var whoIsTyping = [];

            $('#typeForm').submit(function () {
                //submit only if it's not empty
                if ($('#m').val() != "") {
                    socket.emit('say', $('#m').val());
                    //say event means someone transmitted chat
                    $('#m').val('');
                    socket.emit('quitTyping')
                }
                return false;
            });

            $('#nickNameForm').submit(function () {
                nickName = $('#nickName').val();
                $('#nickName').attr('placeholder', 'NickName : ' + nickName);
                socket.emit('setNickName', nickName)
                $('#nickName').val("");
                $('#m').focus();
                return false;
            })

            socket.on('selfData', function (obj) {
                console.log('getting initial data from server');
                nickName = obj.nickName;
                $('#nickName').attr('placeholder', 'NickName : ' + nickName);
                //set #nickNameForm placeholder

            });

            socket.on('setNickName', function (obj) {
                var past = obj.past;
                var current = obj.current;
                var whoIsOn = obj.whoIsOn;

                var msg = `====== ${past} changed nickname to ${current} ======`;
                $('#messages').append($('<li>').text(msg));

                editUsers(whoIsOn);

            })

            socket.on('chat message', function (msg) {
                $('#messages').append($('<li>').text(msg));
            });

            //채팅방 입장 문구
            socket.on('login', function (nickNameArr) {
                var newbie = nickNameArr[nickNameArr.length - 1];
                editUsers(nickNameArr);
                $('#messages').append($('<li>').text(newbie + "님께서 입장하셨습니다."));
            })

            socket.on('typing', function (nickNameArr) {
                var tempMsg = "";
                whoIsTyping = nickNameArr;
                for (person in nickNameArr) {
                    tempMsg += nickNameArr[person] + ', '
                }
                tempMsg = tempMsg.substring(0, tempMsg.length - 2);
                $('#m').attr('placeholder', tempMsg + typingNotice)
            });

            socket.on('mySaying', function (msg) {

                $('#messages').append($('<li>').text(msg));
            });

            socket.on('endTyping', function () {
                console.log('endTyping');
                whoIsTyping = [];
                $('#m').attr('placeholder', "");
            })

            socket.on('logout', function (received) {
                var nickNameArr = received.whoIsOn;
                var disconnected = received.disconnected;
                $('#messages').append($('<li>').text(`${disconnected} 님께서 나가셨습니다.`));
                editUsers(nickNameArr);
            })

            function editUsers(nickNameArr) {

                $('#whoIsInBox ul').children().each((index, item) => {
                    $(item).remove();
                });
                for (person in nickNameArr) {
                    $('#whoIsInBox ul').append($('<li>').text(nickNameArr[person]));
                }
            }


            $('#m').keyup(function (event) {

                if ($('#m').val() != "" && !whoIsTyping.includes(nickName)) {
                    socket.emit('typing');
                    console.log('emit typing');
                } else if ($('#m').val() == "" && whoIsTyping.includes(nickName)) {

                    socket.emit('quitTyping');
                    console.log('emit quitTyping');

                }
            });

        });

    </script>

</head>
<body>

<!--사이드바-->
<div id="wrapper" class="animate">
    <nav class="navbar header-top fixed-top navbar-expand-lg navbar-dark bg-dark">
        <span class="navbar-toggler-icon leftmenutrigger"></span>
        <a class="navbar-brand" href="http://192.168.253.138/main.php"
           style="font-family: 'Monoton', cursive; margin-left: 10px; font-size: 20px;">Every
            Busking</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
                aria-controls="navbarText"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav animate side-nav">
                <li class="nav-item">
                    <a class="nav-link menu_buskingteam" href="http://192.168.253.138//buskingteam/buskingteam.php"
                       title="Dashboard"><i
                            class="fas fa-users side_bar_img"></i>Busking Team<i
                            class="fas fa-cube shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_busking_zone" href="http://192.168.253.138//busking_zone/busking_zone.php"
                       title="Cart"><i
                            class="fas fa-map-marker-alt side_bar_img"></i>Busking Zone<i
                            class="fas fa-cart-plus shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_streaming" href="http://192.168.253.138//streaming/streaming.php"
                       title="Comment"><i
                            class="fas fa-video side_bar_img"></i>Streaming<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_community" href="http://192.168.253.138//community/community.php"
                       title="Comment"><i
                            class="fas fa-star side_bar_img"></i>Community<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link menu_concert" href="http://192.168.253.138//concert/concert.php" title="Comment"><i
                            class="fas fa-compact-disc side_bar_img"></i>Cloud Concert<i
                            class="fas fa-comment shortmenu animate"></i></a>
                </li>
            </ul>
            <ul class="navbar-nav ml-md-auto d-md-flex">
                <li class="nav-item">
                    <a class="nav-link">관리자 님</a>

                </li>
                <li class="nav-item">
                    <a class="nav-link main_nav_sign" href="/Sign/sign_out.php"><i class="fas fa-key"></i> Sign Out</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link menu_profile" href="http://192.168.253.138/my_page/my_page_modify.php"><i
                            class="fas fa-user"></i> My Page</a>
                </li>

            </ul>
        </div>
    </nav>
</div>

<div class="container my_font_main" style="min-height: 800px; border: #FBAA48 1px solid; padding-top: 100px; padding-bottom: 100px">

    <div>
        <ul id="messages" style="height: 400px; width: 80%; border: #FBAA48 1px solid"></ul>
    </div>

    <div id='whoIsInBox' style="border: #FBAA48 1px solid">
        <h1>참여자</h1>

        <ul id='whoIsIn' style="border: #FBAA48 1px solid; width: 10%;display: inline">
            <li>Test In</li>
        </ul>

    </div>
    <form action="" id='typeForm' style="border: #FBAA48 1px solid">
        <input id="m" autocomplete="off" style="width: 90%"/>
        <button class="btn hover_class" id="support_hover" style="width: 9%">Send</button>
    </form>
</div>

<!-- Footer -->
<div data-role="footer" data-position="fixed" class="m_footer">
    <footer class="py-5 bg-dark">
        <div class="container">
            <p class="m-0 text-center text-white my_font_logo">Every Busking</p>
        </div>
        <!-- /.container -->
    </footer>
</div>

<script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js"></script>
<script src="http://192.168.253.138/public/side_bar.js"></script>

</body>
</html>