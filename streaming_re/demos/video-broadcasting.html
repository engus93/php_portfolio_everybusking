<!DOCTYPE html>
<html dir="ltr">
<head>
    <meta charset="utf-8">
    <title>Video OneWay Broadcasting using RTCMultiConnection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <script src="/demos/menu.js"></script>
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Let's Every Busking!</title>

    <!-- Bootstrap core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="http://192.168.253.138/css/modern-business.css" rel="stylesheet">
    <link href="http://192.168.253.138/css/public.css" rel="stylesheet">

    <link href="http://192.168.253.138/public/side_bar.css" rel="stylesheet">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet"
          id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

</head>

<body>
<input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20 style="display: none">
<button id="open-room" style="display: none">Open Room</button>
<button id="join-room" style="display: none">Join Room</button>

<div class="container my_font_main"
     style="min-height: 800px; padding-top: 10px;">

    <h1 class="mt-4 mb-3 my_font_main" style="color: #FBAA48">누구누구의 방송</h1>

    <h6 class="my_font_main">※ 깨끗한 인터넷 문화를 만들어갑시다. :)</h6>

    <div class="row" style="height: 440px; margin-top: 70px">
        <div class="col-lg-8">
            <div id="videos-container" style="margin: 20px 0;"></div>
        </div>

        <div class="col-lg-4" style="height: 100%; margin-top: 20px">
            <div id="messages" style="height: 300px; border: transparent 1px solid; overflow: auto"></div>

            <div id='whoIsInBox' style="min-height: 80px; height: 80px; border: transparent 1px solid;overflow: auto">

                <h4>참여자</h4>

                <div id='whoIsIn' style="border: transparent 1px solid;overflow: auto">
                </div>

            </div>

            <div style="margin-top: 10px;">
                <form id='typeForm' style="border: transparent 1px solid;">
                    <input class="input-group-text" id="m" autocomplete="off"
                           style="width: 270px; display: inline; background-color: white; text-align: left"/>
                    <button class="btn hover_class" id="support_hover" style="width: 70px;">보내기</button>
                </form>
            </div>
        </div>

    </div>

    <a href="http://192.168.253.138/streaming/waiting_room.php" style="margin-left: 480px;">
        <button class="col-sm-2 btn my_font_main hover_class"
                style="font-size: 18px; width: 180px; margin-top: 100px; margin-bottom: 70px;"
                id="support_hover2">목록으로
        </button>
    </a>

</div>

<script src="/dist/RTCMultiConnection.js"></script>
<script src="/node_modules/webrtc-adapter/out/adapter.js"></script>
<script src="/socket.io/socket.io.js"></script>

<!-- custom layout for HTML5 audio/video elements -->
<link rel="stylesheet" href="/dev/getHTMLMediaElement.css">
<script src="/dev/getHTMLMediaElement.js"></script>

<script>

    // ......................................................
    // .......................UI Code........................
    // ......................................................
    // document.getElementById('open-room').onclick = function() {
    //     disableInputButtons();
    //     connection.open(document.getElementById('room-id').value, function() {
    //         showRoomURL(connection.sessionid);
    //     });
    // };

    window.onload = function () {
        disableInputButtons();
        connection.open("zzzzz", function () {
            showRoomURL(connection.sessionid);
        });
    }


    document.getElementById('join-room').onclick = function () {
        disableInputButtons();

        connection.sdpConstraints.mandatory = {
            OfferToReceiveAudio: true,
            OfferToReceiveVideo: true
        };
        connection.join(document.getElementById('room-id').value);
    };

    // ......................................................
    // ..................RTCMultiConnection Code.............
    // ......................................................

    var connection = new RTCMultiConnection();

    // by default, socket.io server is assumed to be deployed on your own URL
    connection.socketURL = '/';

    // comment-out below line if you do not have your own socket.io server
    // connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

    connection.socketMessageEvent = 'video-broadcast-demo';

    connection.session = {
        audio: true,
        video: true,
        oneway: true
    };

    connection.sdpConstraints.mandatory = {
        OfferToReceiveAudio: false,
        OfferToReceiveVideo: false
    };

    connection.videosContainer = document.getElementById('videos-container');
    connection.onstream = function (event) {
        var existing = document.getElementById(event.streamid);
        if (existing && existing.parentNode) {
            existing.parentNode.removeChild(existing);
        }

        event.mediaElement.removeAttribute('src');
        event.mediaElement.removeAttribute('srcObject');
        event.mediaElement.muted = true;
        event.mediaElement.volume = 0;

        var video = document.createElement('video');

        video.height = 430;

        try {
            video.setAttributeNode(document.createAttribute('autoplay'));
            video.setAttributeNode(document.createAttribute('controls'));
            video.setAttributeNode(document.createAttribute('playsinline'));
        } catch (e) {
            video.setAttribute('autoplay', true);
            video.setAttribute('controls', true);
            video.setAttribute('playsinline', true);
        }

        if (event.type === 'local') {
            video.volume = 0;
            try {
                video.setAttributeNode(document.createAttribute('muted'));
            } catch (e) {
                video.setAttribute('muted', true);
            }
        }
        video.srcObject = event.stream;

        var width = parseInt(connection.videosContainer.clientWidth);
        var height = parseInt(connection.videosContainer.clientHeight);
        var mediaElement = getHTMLMediaElement(video, {
            title: event.userid,
            buttons: ['full-screen'],
            width: width,
            height:height,
            showOnMouseEnter: false
        });

        connection.videosContainer.appendChild(mediaElement);

        setTimeout(function () {
            mediaElement.media.play();
        }, 5000);

        mediaElement.id = event.streamid;
    };

    connection.onstreamended = function (event) {
        var mediaElement = document.getElementById(event.streamid);
        if (mediaElement) {
            mediaElement.parentNode.removeChild(mediaElement);

            if (event.userid === connection.sessionid && !connection.isInitiator) {
                alert('Broadcast is ended. We will reload this page to clear the cache.');
                location.reload();
            }
        }
    };

    connection.onMediaError = function (e) {
        if (e.message === 'Concurrent mic process limit.') {
            if (DetectRTC.audioInputDevices.length <= 1) {
                alert('Please select external microphone. Check github issue number 483.');
                return;
            }

            var secondaryMic = DetectRTC.audioInputDevices[1].deviceId;
            connection.mediaConstraints.audio = {
                deviceId: secondaryMic
            };

            connection.join(connection.sessionid);
        }
    };

    // ..................................
    // ALL below scripts are redundant!!!
    // ..................................

    function disableInputButtons() {
        document.getElementById('room-id').onkeyup();

        document.getElementById('open-room').disabled = true;
        document.getElementById('join-room').disabled = true;
        document.getElementById('room-id').disabled = true;
    }

    var roomid = '';
    if (localStorage.getItem(connection.socketMessageEvent)) {
        roomid = localStorage.getItem(connection.socketMessageEvent);
    } else {
        roomid = connection.token();
    }
    document.getElementById('room-id').value = roomid;
    document.getElementById('room-id').onkeyup = function () {
        localStorage.setItem(connection.socketMessageEvent, document.getElementById('room-id').value);
    };

    var hashString = location.hash.replace('#', '');
    if (hashString.length && hashString.indexOf('comment-') == 0) {
        hashString = '';
    }

    var roomid = params.roomid;
    if (!roomid && hashString.length) {
        roomid = hashString;
    }

    if (roomid && roomid.length) {
        document.getElementById('room-id').value = roomid;
        localStorage.setItem(connection.socketMessageEvent, roomid);

        // auto-join-room
        (function reCheckRoomPresence() {
            connection.checkPresence(roomid, function (isRoomExist) {
                if (isRoomExist) {
                    connection.join(roomid);
                    return;
                }

                setTimeout(reCheckRoomPresence, 5000);
            });
        })();

        disableInputButtons();
    }

    // detect 2G
    if (navigator.connection &&
        navigator.connection.type === 'cellular' &&
        navigator.connection.downlinkMax <= 0.115) {
        alert('2G is not supported. Please use a better internet service.');
    }

</script>

<script>

    //when the document is ready.
    $(function () {
        //about DOM
        $('#m').focus();

        //socket io
        var socket = io();
        var typingNotice = ' 님께서 입력 중';
        var nickName = '';
        var user_name = '';
        var whoIsTyping = [];
        var newbie;

        $('#typeForm').submit(function () {
            //submit only if it's not empty
            if ($('#m').val() != "") {
                socket.emit('say', $('#m').val());
                //say event means someone transmitted chat
                $('#m').val('');
                socket.emit('quitTyping')
                console.log("전송");
            }
            return false;
        });

        $('#nickNameForm').submit(function () {
            nickName = $('#nickName').val();
            $('#nickName').attr('placeholder', 'NickName : ' + nickName);
            socket.emit('setNickName', nickName)
            $('#nickName').val("");
            $('#m').focus();
            return false;
        })

        socket.on('selfData', function (obj) {
            nickName = obj.nickName;
            user_name = obj.user_name;
            $('#nickName').attr('placeholder', 'NickName : ' + nickName);
            //set #nickNameForm placeholder
            $('#user_id_id').text(user_name + " 님");
        });

        socket.on('chat message', function (msg) {
            $('#messages').append($('<h6>').text(msg));
        });

        //채팅방 입장 문구
        socket.on('login', function (nickNameArr) {
            console.log(nickNameArr);
            newbie = nickNameArr[nickNameArr.length - 1];
            editUsers(nickNameArr);
            $('#messages').append($('<h6>').text(newbie + "님께서 입장하셨습니다."));
        });

        function editUsers(nickNameArr) {
            console.log(nickNameArr + "나감 1");

            $('#whoIsInBox div').children().each((index, item) => {
                $(item).remove();
                console.log(nickNameArr + "나감 2");
            });

            for (person in nickNameArr) {
                $('#whoIsInBox div').append($('<h6>').text(nickNameArr[person]));
            }
        }

        socket.on('logout', function (received) {
            var nickNameArr = received.nickNameArr;
            var disconnected = received.disconnected;
            $('#messages').append($('<li>').text(`${disconnected} 님께서 나가셨습니다.`));
            editUsers(nickNameArr);
        });

        socket.on('typing', function (nickNameArr) {
            var tempMsg = "";
            whoIsTyping = nickNameArr;
            for (person in nickNameArr) {
                tempMsg += nickNameArr[person]
            }
            tempMsg = tempMsg.substring(0, tempMsg.length - 1);
            $('#m').attr('placeholder', tempMsg + typingNotice)
        });

        socket.on('mySaying', function (msg) {

            $('#messages').append($('<h6>').text(msg));
        });

        socket.on('endTyping', function () {
            console.log('endTyping');
            whoIsTyping = [];
            $('#m').attr('placeholder', "");
        });

        $('#m').keyup(function (event) {

            if ($('#m').val() != "" && !whoIsTyping.includes(nickName)) {
                socket.emit('typing');
                console.log('emit typing');
            } else if ($('#m').val() == "" && whoIsTyping.includes(nickName)) {

                socket.emit('quitTyping');
                console.log('emit quitTyping');

            }
        });

    });

    //뒤로가기 충돌 방지
    history.pushState(null, null, location.href);
    window.onpopstate = function () {
        document.location.href = "../waiting_room.php";
    };

</script>

<footer>
    <small id="send-message"></small>
</footer>

<script src="https://cdn.webrtc-experiment.com/common.js"></script>
</body>
</html>
